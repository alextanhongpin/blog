
<!doctype html>
<html lang="en">
  <head>
    <!-- Include google analytics immediately after the head element. -->
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S327WZBYSF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S327WZBYSF');
</script>


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplying Transaction in Golang with Unit of Work Pattern</title>

    <!-- Use the default prism syntax highlighting theme. -->
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism.css" rel="stylesheet">

    <!-- Include styles. -->
    
    <style>
      @import url(https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Roboto:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&display=swap);:root{--color-red:#ff4444}body{background:#fcfcfc;font-family:Roboto,sans-serif;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;-moz-user-select:none;-ms-user-select:none}h1,h2{font-family:Lora,sans-serif}code:not([class]){background:#ffc5c536;border:1px solid #ffaeae;font-family:Inconsolata,monospace;padding:.1rem .2rem;font-style:initial;border-radius:3px;color:#ec5050}article h1{font-size:2.5em;line-height:calc(1ex / .42);margin:calc(1ex / .42) 0}article h2{font-size:2em;line-height:calc(1ex / .42);margin:calc(1ex / .42) 0}article h3{font-size:1.75em;line-height:calc(1ex / .38);margin:calc(1ex / .38) 0}article h4{font-size:1.5em;line-height:calc(1ex / .37);margin:calc(1ex / .37) 0}article p{font-size:1em;line-height:calc(1ex / .32);margin:calc(1ex / .32) 0}main{min-height:100vh;max-width:40rem;width:100%;margin:auto}header{background:#fff;padding:1rem;position:sticky;top:0}main{padding:1rem}footer{padding:1rem;font-size:small;text-align:center}.header-link{text-decoration:none;font-weight:700;display:grid;grid-template-columns:max-content 1fr;grid-column-gap:0.5rem;align-items:center}.header-link-image{width:2rem;height:2rem;border-radius:50%}.header-anchor{text-decoration:none;color:inherit}:target{background:#fff6c0}.tags{display:grid;grid-template-columns:repeat(auto-fit,minmax(0,max-content));grid-column-gap:0.5rem;grid-row-gap:0.5rem}.tag{background:#eee;border-radius:.5rem;padding:.5rem;line-height:1rem;font-size:small;text-decoration:none;color:inherit;cursor:pointer}.tag:hover{background:#ddd}.post-subheader{display:flex;justify-content:space-between;align-items:center}*,::after,::before{box-sizing:border-box}*{margin:0}body,html{height:100%}body{line-height:1.5;-webkit-font-smoothing:antialiased}canvas,img,picture,svg,video{display:block;max-width:100%}button,input,select,textarea{font:inherit}h1,h2,h3,h4,h5,h6,p{overflow-wrap:break-word}#__next,#root{isolation:isolate}
    </style>
  </head>

  <body>
    <header>
      <a class='header-link' href='/blog/' rel="noopener noreferrer">
        <img class='header-link-image' src='/blog/assets/profile.jpeg' alt='profile picture'/> Alex&#39;s {Code} Blog 
      </a>
    </header>

    <main>
      
<article>
	<h1> Simplying Transaction in Golang with Unit of Work Pattern </h1>
	<p class='post-subheader'>
		<small>Posted Feb 27, 2023 (Last updated: Feb 27, 2023)</small>
		<small>5 minutes</small>
	</p>

	<div class='tags'><a class='tag' href='/blog/tag/golang'>golang</a><a class='tag' href='/blog/tag/database'>database</a></div>

	<p><em>Unit of Work (or short, <code>UoW</code>)</em> is a pattern of grouping multiple database operations and executing them as a single atomic operation. An operation is atomic if all the suboperations complete, or none of them do.</p>
<h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="#the-problem">The Problem</a></h2>
<p>In your application, you may want to ensure multiple database operations happen in a single transaction. This could be an insert operation to multiple tables, for example.Transactions are important to ensure data integrity. If the first insert succeeds but the second fails, the first operation should rollback so that none of the inserts happen.</p>
<p>This is where the <em>Unit of Work</em> (<code>UoW</code>) pattern shines. The implementation details for managing the transaction lifecycle are abstracted by the <em>Unit of Work</em>. This pattern starts a transaction and automatically commits it at the end, or otherwise performs a rollback if an error occurs.</p>
<h2 id="the-interface" tabindex="-1"><a class="header-anchor" href="#the-interface">The Interface</a></h2>
<p>The <code>UoW</code> interface is relatively simple:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">type</span> unitOfWork <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">RunInTx</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>txCtx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span><br><span class="token punctuation">}</span></code></pre>
<p><code>RunInTx</code> wraps a function as an atomic operation. The function has access to the transaction instance through context propagation. One interesting property of this implementation is that transactions can <strong>never</strong> be nested.</p>
<p>Even if <code>RunInTx</code> is called multiple times within itself, only one transaction is created. Only that transaction, which we will refer to as the <em>root transaction</em>, can commit or rollback the operation. This will be particularly useful in testing, which we will see later.</p>
<pre class="language-go"><code class="language-go"><span class="token comment">// RunInTx wraps the operation in a transaction. If a context containing tx is</span><br><span class="token comment">// passed in, then it will use the context tx. Transaction cannot be nested.</span><br><span class="token comment">// The transaction can only be committed by the parent.</span><br><span class="token keyword">func</span> <span class="token punctuation">(</span>uow <span class="token operator">*</span>UnitOfWork<span class="token punctuation">)</span> <span class="token function">RunInTx</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> <span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">if</span> <span class="token function">isTxContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">if</span> uow<span class="token punctuation">.</span><span class="token function">IsTx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> uow<span class="token punctuation">)</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> uow<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">BeginTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">getUowOptions</span><span class="token punctuation">(</span>opts<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Tx<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> err<br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">if</span> p <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			<span class="token comment">// A panic occur, rollback and repanic.</span><br>			err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>			<span class="token function">panic</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			<span class="token comment">// Something went wrong, rollback, but keep the original error.</span><br>			<span class="token boolean">_</span> <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>			<span class="token comment">// Success, commit.</span><br>			err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">newTx</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>The full implementation can be found at <a href="https://github.com/alextanhongpin/uow">github.com/alextanhongpin/uow</a>.</p>
<h2 id="code-example" tabindex="-1"><a class="header-anchor" href="#code-example">Code Example</a></h2>
<p>The source code is available <a href="https://github.com/alextanhongpin/go-unit-of-work">here</a>.</p>
<p>The example below follows a simple <em>User Device Registration</em> use case that inserts data into two separate tables atomically. The <em>application service layer</em> (in this case, the <em>use case layer</em>) typically initialises the <em>Unit of Work</em>. This layer is usually just one layer above the <em>repository layer</em>.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">type</span> userRepository <span class="token keyword">interface</span> <span class="token punctuation">{</span><br>	<span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> email <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br>	<span class="token function">CreateUserDevice</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userID uuid<span class="token punctuation">.</span>UUID<span class="token punctuation">,</span> deviceID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>UserDevice<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">type</span> UserUseCase <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	uow  uow<span class="token punctuation">.</span>UOW<br>	repo userRepository<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>uc <span class="token operator">*</span>UserUseCase<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> email<span class="token punctuation">,</span> deviceID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>	<span class="token keyword">return</span> uc<span class="token punctuation">.</span>uow<span class="token punctuation">.</span><span class="token function">RunInTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>		<span class="token comment">// The first operation inserts a new user.</span><br>		user<span class="token punctuation">,</span> err <span class="token operator">:=</span> uc<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> email<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>			<span class="token keyword">return</span> err<br>		<span class="token punctuation">}</span><br><br>		<span class="token comment">// The second operation inserts a new user device.</span><br>		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> uc<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">CreateUserDevice</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> deviceID<span class="token punctuation">)</span><br>		<span class="token keyword">return</span> err<br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<p>Our <code>repository.go</code>:</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">type</span> PostgresUserRepository <span class="token keyword">struct</span> <span class="token punctuation">{</span><br>	uow uow<span class="token punctuation">.</span>UOW<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>PostgresUserRepository<span class="token punctuation">)</span> <span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> email <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token comment">// DB extracts the *sql.Tx from the context, or initialize a new *sql.DB.</span><br>	db <span class="token operator">:=</span> p<span class="token punctuation">.</span>uow<span class="token punctuation">.</span><span class="token function">DB</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><br><br>	<span class="token keyword">var</span> u User<br>	err <span class="token operator">:=</span> db<span class="token punctuation">.</span><br>		<span class="token function">QueryRowContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> createUserStmt<span class="token punctuation">,</span> email<span class="token punctuation">)</span><span class="token punctuation">.</span><br>		<span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>u<span class="token punctuation">.</span>Email<span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create user: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	<span class="token keyword">return</span> <span class="token operator">&amp;</span>u<span class="token punctuation">,</span> <span class="token boolean">nil</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="transaction-in-integration-tests" tabindex="-1"><a class="header-anchor" href="#transaction-in-integration-tests">Transaction in Integration Tests</a></h2>
<p>When running unit tests, it is often faster to rollback the transaction than to truncate tables or recreate the database. We can take advantage of the fact that the <code>uow</code> library ensures that transactions can not be nested. We return a <em>sentinel error</em>, <code>ErrRollback</code> at the end of <code>RunInTx</code> to ensure the operations are not committed.</p>
<pre class="language-go"><code class="language-go"><span class="token keyword">var</span> ErrRollback <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"test: rollback"</span><span class="token punctuation">)</span><br><br><span class="token keyword">func</span> <span class="token function">TestUserUseCase</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token comment">// Arrange.</span><br>	u <span class="token operator">:=</span> uow<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><br>	repo <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewPostgresUserRepository</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><br>	uc <span class="token operator">:=</span> app<span class="token punctuation">.</span><span class="token function">NewUserUseCase</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> repo<span class="token punctuation">)</span><br><br>	<span class="token comment">// In the happy path, create user succeeds.</span><br>	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">"happy path"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		email <span class="token operator">:=</span> <span class="token string">"john.appleseed@gmail.com"</span><br>		deviceID <span class="token operator">:=</span> <span class="token string">"ios-123"</span><br><br>		<span class="token comment">// Act.</span><br>		<span class="token comment">// Wrap the operation in a transaction and rollback after the test complete.</span><br>		err <span class="token operator">:=</span> u<span class="token punctuation">.</span><span class="token function">RunInTx</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span><br>			<span class="token comment">// Even though Register method calls `RunInTx`, it will not create a new</span><br>			<span class="token comment">// transaction.</span><br>			<span class="token keyword">if</span> err <span class="token operator">:=</span> uc<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> email<span class="token punctuation">,</span> deviceID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>				t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to register user: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>				<span class="token keyword">return</span> err<br>			<span class="token punctuation">}</span><br><br>			<span class="token comment">// Assert.</span><br>			<span class="token comment">// ...</span><br><br>			<span class="token comment">// Rollback the operation, instead of truncating the table for every tests.</span><br>			<span class="token keyword">return</span> ErrRollback<br>		<span class="token punctuation">}</span><span class="token punctuation">)</span><br><br>		<span class="token comment">// The returned error must be ErrRollback.</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> ErrRollback<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"failed to rollback: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre>
<h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary">Summary</a></h2>
<p><em>Unit of Work</em> is a useful pattern when we need our operations to be atomic.</p>

</article>

    </main>

    <footer>
      Alex&#39;s {Code} Blog © 2023 • All rights reserved.
    </footer>
  </body>
</html>
